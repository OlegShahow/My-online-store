"use strict";

"use strict";

window.addEventListener('DOMContentLoaded', () => {

	// =======================================
	// –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –ó–ê–ö–ê–ó–ê –í FORMSPREE
	// =======================================
	function sendOrderToFormspree(cart, totalAmount) {
		console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞ –≤ Formspree...');

		const formData = new FormData();

		// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ
		formData.append('–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞', totalAmount + ' –≥—Ä–Ω');
		formData.append('–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞', new Date().toLocaleString('ru-RU'));
		formData.append('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤', cart.length + ' —à—Ç.');
		formData.append('–û–±—â–∞—è —Å—É–º–º–∞', totalAmount + ' –≥—Ä–Ω');

		// –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º —Ç–æ–≤–∞—Ä–µ
		cart.forEach((item, index) => {
			const itemTotal = (item.price * item.quantity).toFixed(2);

			formData.append(`–¢–æ–≤–∞—Ä ${index + 1} - –ù–∞–∑–≤–∞–Ω–∏–µ`, item.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è');
			formData.append(`–¢–æ–≤–∞—Ä ${index + 1} - –¶–µ–Ω–∞ –∑–∞ —à—Ç.`, item.price + ' –≥—Ä–Ω');
			formData.append(`–¢–æ–≤–∞—Ä ${index + 1} - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ`, item.quantity + ' —à—Ç.');
			formData.append(`–¢–æ–≤–∞—Ä ${index + 1} - –°—É–º–º–∞`, itemTotal + ' –≥—Ä–Ω');
			formData.append(`–¢–æ–≤–∞—Ä ${index + 1} - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ`, item.img || '–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
		});

		// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ Formspree
		fetch('https://formspree.io/f/xpwjbozp', {
			method: 'POST',
			body: formData,
			headers: {
				'Accept': 'application/json'
			}
		})
			.then(response => {
				if (response.ok) {
					return response.json();
				}
				throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞');
			})
			.then(data => {
				console.log('‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Formspree:', data);
				showNotification('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.');
			})
			.catch(error => {
				console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞:', error);
				showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
			});
	}

	// =======================================
	// –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò –û–§–û–†–ú–õ–ï–ù–ò–Ø –ó–ê–ö–ê–ó–ê
	// =======================================
	document.querySelector('.checkout-btn').addEventListener('click', function () {
		const cart = JSON.parse(localStorage.getItem('cart')) || [];
		const totalAmount = document.querySelector('.total-amount').textContent;

		if (cart.length === 0) {
			alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!');
			return;
		}

		// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
		if (confirm(`–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ —Å—É–º–º—É ${totalAmount} –≥—Ä–Ω?`)) {
			// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –≤ Formspree
			sendOrderToFormspree(cart, totalAmount);

			console.log('‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω:', cart);
			showNotification('–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');

			// –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –ø–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
			localStorage.removeItem('cart');

			// –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
			loadCart();
		}
	});

	// =======================================
	// –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò –û–ß–ò–°–¢–ö–ò –ö–û–†–ó–ò–ù–´
	// =======================================
	document.querySelector('.clear-corzina').addEventListener('click', function () {
		const cart = JSON.parse(localStorage.getItem('cart')) || [];

		if (cart.length === 0) {
			alert('–ö–æ—Ä–∑–∏–Ω–∞ —É–∂–µ –ø—É—Å—Ç–∞!');
			return;
		}

		if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) {
			localStorage.removeItem('cart');
			loadCart();
			showNotification('–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞!');
		}
	});

	// –û—Å—Ç–∞–ª—å–Ω–æ–π –≤–∞—à –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
	// [–ó–¥–µ—Å—å –æ—Å—Ç–∞–µ—Ç—Å—è –≤–µ—Å—å –≤–∞—à –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥: loadCart, updateQuantity, removeItem, showNotification –∏ —Ç.–¥.]

});


// –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –±–ª–æ–∫:
// ‚úÖ –ë–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∫–æ—Ä–∑–∏–Ω—ã
// ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ - –Ω–µ –ª–æ–≤–∏—Ç –∫–ª–∏–∫–∏ –ø–æ –¥—Ä—É–≥–∏–º —ç–ª–µ–º–µ–Ω—Ç–∞–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
// ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–µ–µ - –º–µ–Ω—å—à–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ
// ‚úÖ –õ–æ–≥–∏—á–Ω–µ–µ - —Å–æ–±—ã—Ç–∏—è –∫–æ—Ä–∑–∏–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∫–æ—Ä–∑–∏–Ω—ã


// –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ:
// –û–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–æ—Ä–∑–∏–Ω—ã
// –ü—Ä–æ–≤–µ—Ä–∫–∞: e.target.closest('.cart-item') - –Ω–∞—Ö–æ–¥–∏–º —Ç–æ–≤–∞—Ä –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –∫–ª–∏–∫–Ω—É–ª–∏
// –ü—Ä–æ–≤–µ—Ä–∫–∞: e.target.dataset.action - –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å
// –î–µ–π—Å—Ç–≤–∏–µ: –≤—ã–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é

// –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–∞–∫–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:
// –†–∞–±–æ—Ç–∞–µ—Ç —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ - –Ω–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
// –≠–∫–æ–Ω–æ–º–∏—Ç –ø–∞–º—è—Ç—å - –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–º–µ—Å—Ç–æ –º–Ω–æ–≥–∏—Ö
// –õ–µ–≥–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å - –≤—Å—è –ª–æ–≥–∏–∫–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞


//    –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –Ω–µ –≤–∏—Ä—Ç —Å–µ—Ä–≤–µ—Ä

// –ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:
// –§—É–Ω–∫—Ü–∏—è sendOrderToFormspree() - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã –Ω–∞ –≤–∞—à Formspree endpoint
// –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ - —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã - —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º

// –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
// ‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ —É–¥–æ–±–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è —á—Ç–µ–Ω–∏—è
// ‚úÖ –í–∫–ª—é—á–∞–µ—Ç –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–∞—Ö(–Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Å—É–º–º–∞)
// ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
// ‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–π / –Ω–µ—É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ
// ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ —Å –≤–∞—à–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –¥–∞–Ω–Ω—ã—Ö



// ..................   –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –ö–û–†–ó–ò–ù–´ –ß–ï–†–ï–ó –ö–ù–û–ü–ö–£  .......................................



document.querySelector('.clear-corzina').addEventListener('click', () => {
	if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) {
		localStorage.removeItem('cart');
		loadCart(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
		alert('–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞!');
	}
});


// ................................    –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã ..................


// =======================================
// –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –î–ê–ù–ù–´–• –ö–û–†–ó–ò–ù–´
// =======================================
function sendCartData() {
	const cartItems = document.querySelectorAll('.cart-item');
	const form = document.getElementById('cartForm');

	// –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
	const existingInputs = form.querySelectorAll('[name^="product_"]');
	existingInputs.forEach(input => input.remove());

	// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ
	document.getElementById('formTotal').value = document.querySelector('.total-amount').textContent + ' –≥—Ä–Ω';
	document.getElementById('formCount').value = cartItems.length + ' —à—Ç.';

	// –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
	cartItems.forEach((item, index) => {
		const name = item.querySelector('h3')?.textContent || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
		const price = item.querySelector('.item-price')?.textContent.replace('–¶–µ–Ω–∞: ', '') || '0 –≥—Ä–Ω';
		const quantity = item.querySelector('.quantity')?.textContent || '1';
		const total = item.querySelector('.item-total')?.textContent.replace('–°—É–º–º–∞: ', '') || '0 –≥—Ä–Ω';

		// –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
		createHiddenInput(form, `product_${index}_name`, name);
		createHiddenInput(form, `product_${index}_price`, price);
		createHiddenInput(form, `product_${index}_quantity`, quantity);
		createHiddenInput(form, `product_${index}_total`, total);
	});

	// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
	fetch(form.action, {
		method: 'POST',
		body: new FormData(form),
		headers: {
			'Accept': 'application/json'
		}
	})
		.then(response => response.json())
		.then(data => {
			console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã:', data);
			alert('–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã.');
		})
		.catch(error => {
			console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
			alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
		});
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π
function createHiddenInput(form, name, value) {
	const input = document.createElement('input');
	input.type = 'hidden';
	input.name = name;
	input.value = value;
	form.appendChild(input);
}

// =======================================
// –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò –û–§–û–†–ú–õ–ï–ù–ò–Ø –ó–ê–ö–ê–ó–ê
// =======================================
document.querySelector('.checkout-btn').addEventListener('click', function () {
	const cart = JSON.parse(localStorage.getItem('cart')) || [];

	if (cart.length === 0) {
		alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!');
		return;
	}

	if (confirm(`–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ —Å—É–º–º—É ${document.querySelector('.total-amount').textContent} –≥—Ä–Ω?`)) {
		sendCartData(); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã

		// –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
		localStorage.removeItem('cart');
		loadCart();
	}
});